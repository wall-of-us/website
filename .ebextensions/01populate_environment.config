commands:
  create_post_dir:
    command: "mkdir /opt/elasticbeanstalk/hooks/appdeploy/post"
    ignoreErrors: true

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/91_write_environment.py":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env python
      import json
      import os
      import subprocess

      subprocess.call(["pip","install","boto3"])
      import boto3
      config = json.load(open("/opt/elasticbeanstalk/deploy/configuration/containerconfiguration"))
      env_name = subprocess.check_output(["python","/tmp/get_environment_name.py"]).rstrip('\n')
      user = config['container']['app_user']
      print "Loading .env file from dynamoDB env['%s']['value']" % env_name
      client = boto3.client('dynamodb', region_name='us-west-2')
      data = client.get_item(TableName='config',Key={"env":{'S':env_name}})['Item']['value']['S']

      with os.fdopen(os.open('/var/app/current/.env', os.O_WRONLY | os.O_CREAT, 0o600), 'w') as handle:
        handle.write(data)
      subprocess.call(["chown",user,"/var/app/current/.env"])
